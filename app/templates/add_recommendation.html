{% extends "base.html" %}

{% block title %}Recommend Places for {{ trip.traveler_name }}'s Trip to {{ trip.destination }} | Recs{% endblock %}

{% block content %}
<div class="flex flex-col h-screen">
  <div class="flex-grow flex flex-col items-center justify-center px-4 py-10 max-w-3xl mx-auto w-full">
    <h1 class="text-3xl font-bold text-gray-900 mb-8 text-center">
      {{ trip.traveler_name }} is going to {{ trip.destination }}. Where should they go?
    </h1>
    
    <form id="step1-form" method="POST" action="{{ url_for('main.process_recommendation', slug=trip.slug) }}" class="w-full">
      <div class="w-full">
        <div class="flex justify-between items-center mb-4">
          <div class="text-lg font-medium text-gray-700">Share your recommendations:</div>
          <div class="flex space-x-3">
            <button type="button" id="toggle-input-btn" class="px-3 py-1 text-sm bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200 transition">
              <span id="text-mode-label" class="hidden">Switch to Text</span>
              <span id="audio-mode-label">Switch to Audio</span>
            </button>
          </div>
        </div>
        
        <div id="text-input-container">
          <textarea 
            name="unstructured_recommendations" 
            id="text-recommendations"
            class="w-full h-64 p-4 text-gray-700 text-lg border-0 focus:ring-0 focus:outline-none resize-none" 
            placeholder="Just start typing your recommendations here...
            
For example:
- That amazing rooftop bar with the view of the Acropolis
- The coffee shop on the corner of the square that serves the best freddo espresso
- The restaurant with the amazing moussaka that's run by the old couple"
            autofocus
          ></textarea>
        </div>
        
        <div id="audio-input-container" class="hidden flex flex-col items-center justify-center h-64 border-2 border-dashed border-gray-300 bg-gray-50 rounded-lg">
          <input type="hidden" id="audio-recommendations" name="audio_recommendations">
          
          <div id="audio-instructions" class="text-center mb-4">
            <p class="text-gray-700 mb-2">Click the button below to start recording your recommendations</p>
            <p class="text-sm text-gray-500">Speak clearly about the places {{ trip.traveler_name }} should visit in {{ trip.destination }}</p>
          </div>
          
          <div id="audio-controls" class="flex flex-col items-center">
            <button type="button" id="record-btn" class="flex items-center justify-center w-16 h-16 bg-red-500 hover:bg-red-600 text-white rounded-full mb-2 focus:outline-none transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
              </svg>
            </button>
            <span id="recording-status" class="text-gray-700">Start Recording</span>
          </div>
          
          <div id="recording-time" class="mt-4 hidden">
            <span id="minutes">00</span>:<span id="seconds">00</span>
          </div>
          
          <div id="audio-player-container" class="mt-4 w-full max-w-md hidden">
            <audio id="audio-playback" controls class="w-full"></audio>
          </div>
          
          <div id="transcription-status" class="mt-4 hidden">
            <div class="flex items-center">
              <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span>Converting your audio to recommendations...</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="mt-8 flex justify-center">
        <button id="submit-button" type="submit" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition flex items-center" disabled>
          <span>Continue</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
          <svg id="spinner" class="animate-spin h-5 w-5 ml-2 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962
            0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block styles %}
<style>
  body {
    background-color: white;
  }
  textarea::placeholder {
    color: #CBD5E0;
  }
  
  #record-btn.recording {
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
    }
    
    70% {
      transform: scale(1.1);
      box-shadow: 0 0 0 10px rgba(220, 38, 38, 0);
    }
    
    100% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(220, 38, 38, 0);
    }
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Form elements
    const form = document.getElementById('step1-form');
    const submitButton = document.getElementById('submit-button');
    const buttonText = submitButton.querySelector('span');
    const arrowIcon = submitButton.querySelector('svg:not(#spinner)');
    const spinner = document.getElementById('spinner');
    
    // Input toggle
    const toggleBtn = document.getElementById('toggle-input-btn');
    const textModeLabel = document.getElementById('text-mode-label');
    const audioModeLabel = document.getElementById('audio-mode-label');
    const textInputContainer = document.getElementById('text-input-container');
    const audioInputContainer = document.getElementById('audio-input-container');
    const textRecommendations = document.getElementById('text-recommendations');
    const audioRecommendations = document.getElementById('audio-recommendations');
    
    // Audio recording elements
    const recordBtn = document.getElementById('record-btn');
    const recordingStatus = document.getElementById('recording-status');
    const recordingTime = document.getElementById('recording-time');
    const minutesDisplay = document.getElementById('minutes');
    const secondsDisplay = document.getElementById('seconds');
    const audioPlayerContainer = document.getElementById('audio-player-container');
    const audioPlayback = document.getElementById('audio-playback');
    const transcriptionStatus = document.getElementById('transcription-status');
    
    // Variables for recording
    let mediaRecorder;
    let audioChunks = [];
    let recording = false;
    let timer;
    let seconds = 0;
    let blob;
    let audioMode = false;

    // Enable/disable submit button based on input
    function updateSubmitButton() {
      if (audioMode) {
        // In audio mode, enable if audio is recorded
        submitButton.disabled = !audioPlayback.src;
      } else {
        // In text mode, enable if text is entered
        submitButton.disabled = !textRecommendations.value.trim();
      }
    }
    
    // Initialize to disabled
    submitButton.disabled = true;
    
    // Listen for text input
    textRecommendations.addEventListener('input', updateSubmitButton);
    
    // Toggle between text and audio modes
    toggleBtn.addEventListener('click', function() {
      audioMode = !audioMode;
      
      if (audioMode) {
        textInputContainer.classList.add('hidden');
        audioInputContainer.classList.remove('hidden');
        textModeLabel.classList.remove('hidden');
        audioModeLabel.classList.add('hidden');
      } else {
        textInputContainer.classList.remove('hidden');
        audioInputContainer.classList.add('hidden');
        textModeLabel.classList.add('hidden');
        audioModeLabel.classList.remove('hidden');
      }
      
      updateSubmitButton();
    });
    
    // Audio recording functionality
    recordBtn.addEventListener('click', toggleRecording);
    
    function toggleRecording() {
      if (!recording) {
        startRecording();
      } else {
        stopRecording();
      }
    }
    
    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        
        // Start recording
        audioChunks = [];
        mediaRecorder.start();
        recording = true;
        
        // Update UI
        recordBtn.classList.add('recording');
        recordingStatus.textContent = 'Recording...';
        recordingTime.classList.remove('hidden');
        
        // Hide player and reset if there was a previous recording
        audioPlayerContainer.classList.add('hidden');
        audioPlayback.src = '';
        
        // Start timer
        startTimer();
        
        // Handle data
        mediaRecorder.addEventListener('dataavailable', function(e) {
          audioChunks.push(e.data);
        });
        
        mediaRecorder.addEventListener('stop', function() {
          // Create audio blob
          blob = new Blob(audioChunks, { type: 'audio/webm' });
          
          // Create URL for playback
          const audioURL = URL.createObjectURL(blob);
          audioPlayback.src = audioURL;
          
          // Show player
          audioPlayerContainer.classList.remove('hidden');
          
          // Process for transcription
          processAudioForTranscription(blob);
          
          // Update submit button
          updateSubmitButton();
        });
      } catch (err) {
        console.error('Error accessing microphone:', err);
        alert('Unable to access your microphone. Please ensure it is connected and you have granted permission.');
      }
    }
    
    function stopRecording() {
      if (mediaRecorder && recording) {
        mediaRecorder.stop();
        recording = false;
        
        // Update UI
        recordBtn.classList.remove('recording');
        recordingStatus.textContent = 'Record Again';
        
        // Stop timer
        clearInterval(timer);
      }
    }
    
    function startTimer() {
      seconds = 0;
      updateTimerDisplay();
      
      timer = setInterval(function() {
        seconds++;
        updateTimerDisplay();
        
        // Auto-stop after 5 minutes (300 seconds)
        if (seconds >= 300) {
          stopRecording();
        }
      }, 1000);
    }
    
    function updateTimerDisplay() {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      
      minutesDisplay.textContent = minutes.toString().padStart(2, '0');
      secondsDisplay.textContent = remainingSeconds.toString().padStart(2, '0');
    }
    
    async function processAudioForTranscription(audioBlob) {
      // Show transcription status
      transcriptionStatus.classList.remove('hidden');
      
      // Create a FormData object to send the file
      const formData = new FormData();
      formData.append('audio', audioBlob, 'recording.webm');
      formData.append('destination', '{{ trip.destination }}');
      
      try {
        // Use fetch to send the audio file to the server for transcription
        const response = await fetch('/api/transcribe', {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error('Failed to transcribe audio');
        }
        
        const data = await response.json();
        
        // Store the transcribed text in a hidden field to be submitted with the form
        if (data.recommendations) {
          // Store the recommendations in the hidden input
          audioRecommendations.value = JSON.stringify(data.recommendations);
          
          // Allow form submission
          submitButton.disabled = false;
        }
      } catch (error) {
        console.error('Error processing audio:', error);
        alert('There was an error processing your audio. Please try again or use text input instead.');
      } finally {
        // Hide transcription status
        transcriptionStatus.classList.add('hidden');
      }
    }

    // Form submission
    form.addEventListener('submit', function(e) {
      if (!form.checkValidity()) {
        return;
      }
      
      // If in audio mode and we have processed audio data
      if (audioMode && audioRecommendations.value) {
        // We already have the recommendations in JSON format
        // Prevent the normal form submission and handle it differently
        e.preventDefault();
        
        // Disable button
        submitButton.disabled = true;
        submitButton.classList.add('opacity-75', 'cursor-not-allowed');
        
        // Hide arrow icon, show spinner
        arrowIcon.classList.add('hidden');
        spinner.classList.remove('hidden');
        
        // Change text
        buttonText.textContent = 'Processing...';
        
        // Post the audio recommendations directly
        fetch(`/trip/${encodeURIComponent('{{ trip.slug }}')}/process-audio`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: audioRecommendations.value
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          // Redirect to the confirmation page
          window.location.href = data.redirect_url;
        })
        .catch(error => {
          console.error('Error:', error);
          alert('There was an error processing your audio. Please try again.');
          
          // Re-enable button
          submitButton.disabled = false;
          submitButton.classList.remove('opacity-75', 'cursor-not-allowed');
          arrowIcon.classList.remove('hidden');
          spinner.classList.add('hidden');
          buttonText.textContent = 'Continue';
        });
      } else {
        // Normal text submission, just need to disable the button and show spinner
        submitButton.disabled = true;
        submitButton.classList.add('opacity-75', 'cursor-not-allowed');
        
        // Hide arrow icon, show spinner
        arrowIcon.classList.add('hidden');
        spinner.classList.remove('hidden');
        
        // Change text
        buttonText.textContent = 'Processing...';
      }
    });
  });
</script>
{% endblock %} 