{% extends "base.html" %}

{% block title %}Confirm Your Recommendations for {{ trip.traveler_name }} | Recs{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-10 max-w-5xl">
  <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4 text-center">
    Your {{ trip.destination }} Recommendations
  </h1>
  
  <p class="text-lg text-gray-600 mb-8 text-center max-w-3xl mx-auto">
    Include details or add more recommendations to make {{ trip.traveler_name }}'s trip to {{ trip.destination }} even better.
  </p>
  
  <!-- Client-side flash message for removed recommendations -->
  <div id="client-flash-container" class="hidden">
    <div class="bg-yellow-100 text-yellow-800 border border-yellow-300 rounded-lg p-4 mb-6 flex items-center">
      <i data-feather="alert-triangle" class="h-5 w-5 mr-3 text-yellow-500"></i>
      <div class="flex-1">Recommendation removed</div>
      <button id="undo-button" class="ml-4 px-3 py-1 bg-white text-gray-800 text-sm rounded hover:bg-gray-200 transition font-medium">
        Undo
      </button>
      <button type="button" class="p-1.5 ml-3 rounded-full hover:bg-white/20" onclick="this.parentElement.classList.add('hidden')">
        <span class="sr-only">Dismiss</span>
        <i data-feather="x" class="h-4 w-4"></i>
      </button>
    </div>
  </div>
  
  {% if not extracted_recommendations or extracted_recommendations|length == 0 %}
    <!-- No recommendations found section -->
    <div class="bg-white rounded-xl p-8 border border-gray-200 shadow-sm mb-8">
      <div class="text-center">
        <div class="inline-flex items-center justify-center h-16 w-16 rounded-full bg-yellow-100 mb-5">
          <i data-feather="search" class="h-8 w-8 text-yellow-700"></i>
        </div>
        <h2 class="text-2xl font-bold text-gray-900 mb-3">No Recommendations Found</h2>
        <p class="text-gray-600 mb-5 max-w-md mx-auto">
          We couldn't identify any specific recommendations for {{ trip.destination }} from what you shared.
        </p>
      </div>
    </div>
    
    <!-- Form to manually add recommendations when none were detected -->
    <form method="POST" action="{{ url_for('main.save_recommendations', slug=trip.slug) }}" class="space-y-6" id="recommendations-form">
      <!-- Hidden recommender name field that will be filled by the modal -->
      <input type="hidden" id="recommender_name" name="recommender_name" value="{{ recommender_name }}">
      
      <!-- Column headers for desktop -->
      <div class="hidden md:flex md:flex-row gap-4 px-4 mb-2">
        <div class="md:w-2/5 font-semibold text-gray-700">Recommendation</div>
        <div class="md:w-3/5 font-semibold text-gray-700">What's special about it?</div>
      </div>
      
      <!-- Recommendations Container -->
      <div id="recommendations-container" class="space-y-4">
        <!-- Manual recommendations will be added here via JavaScript -->
      </div>
      
      <!-- Add More Recommendations Button -->
      <div class="pt-4">
        <button type="button" id="add-recommendation-button" class="inline-flex items-center justify-center px-4 py-2 border border-blue-600 rounded-md text-blue-600 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
          <i data-feather="plus" class="h-5 w-5 mr-2"></i>
          <span>Add a Recommendation</span>
        </button>
      </div>
      
      <!-- Submit Button -->
      <div class="pt-6 flex justify-end">
        <button id="submit-button" type="button" class="inline-flex items-center justify-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-sm transition">
          <span>Send Recommendations</span>
          <i data-feather="arrow-right" class="h-5 w-5 ml-2"></i>
          <i data-feather="loader" id="spinner" class="animate-spin h-5 w-5 ml-2 hidden"></i>
        </button>
      </div>
    </form>
  {% else %}
    <form method="POST" action="{{ url_for('main.save_recommendations', slug=trip.slug) }}" class="space-y-6" id="recommendations-form">
      <!-- Hidden recommender name field that will be filled by the modal -->
      <input type="hidden" id="recommender_name" name="recommender_name" value="{{ recommender_name }}">
      
      <!-- Column headers for desktop -->
      <div class="hidden md:flex md:flex-row gap-4 px-4 mb-2">
        <div class="md:w-2/5 font-semibold text-gray-700">Recommendation</div>
        <div class="md:w-3/5 font-semibold text-gray-700">What's special about it?</div>
      </div>
      
      <!-- Recommendations Container -->
      <div id="recommendations-container" class="space-y-4">
        {% for item in extracted_recommendations %}
        <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm transition hover:shadow-md recommendation-item" id="recommendation-{{ loop.index }}">
          <div class="flex flex-col md:flex-row gap-6">
            <!-- Recommendation Details -->
            <div class="md:w-2/5">
              <h3 class="font-bold text-lg text-gray-900 mb-2">{{ item.name }}</h3>
              
              {% if item.type %}
              <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 mb-3">
                {{ item.type }}
              </div>
              {% endif %}
              
              <input type="hidden" name="recommendations[]" value="{{ item.name }}">
              <input type="hidden" name="place_types[]" value="{{ item.type }}">
              <input type="hidden" name="website_urls[]" value="{{ item.website_url if item.website_url else '' }}">
            </div>
            
            <!-- Description Textarea -->
            <div class="md:w-3/5 flex flex-col">
              <!-- Mobile specific label -->
              <label class="md:hidden text-gray-700 font-medium mb-1 text-sm">Why do you recommend it?</label>
              <textarea 
                id="description_{{ loop.index }}" 
                name="descriptions[]" 
                class="flex-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                rows="3" 
                placeholder="What makes this place special? Any tips for {{ trip.traveler_name }}?"
              >{{ item.description }}</textarea>
            </div>
            
            <!-- Delete button (works on all screen sizes) -->
            <div class="flex items-start">
              <button type="button" class="p-2 rounded-full text-red-500 hover:bg-red-50 hover:text-red-700 transition remove-recommendation" 
                      data-index="{{ loop.index }}" aria-label="Remove recommendation">
                <i data-feather="x" class="h-5 w-5"></i>
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <!-- Add More Recommendations Section -->
      <div class="pt-4">
        <button type="button" id="add-recommendation-button" class="inline-flex items-center justify-center px-4 py-2 border border-blue-600 rounded-md text-blue-600 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
          <i data-feather="plus" class="h-5 w-5 mr-2"></i>
          <span>Add a Recommendation</span>
        </button>
      </div>
      
      <!-- Submit Button -->
      <div class="pt-6 flex justify-end">
        <button id="submit-button" type="button" class="inline-flex items-center justify-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-sm transition">
          <span>Send Recommendations</span>
          <i data-feather="arrow-right" class="h-5 w-5 ml-2"></i>
          <i data-feather="loader" id="spinner" class="animate-spin h-5 w-5 ml-2 hidden"></i>
        </button>
      </div>
    </form>
  {% endif %}
</div>

<!-- Template for new recommendation item (hidden) -->
<template id="new-recommendation-template">
  {% include 'components/additional_recommendation_item_template.html' %}
</template>

<!-- Name Input Modal -->
<div 
  id="name-modal" 
  class="hidden fixed inset-0 z-50 overflow-y-auto" 
  aria-labelledby="name-modal-title" 
  role="dialog" 
  aria-modal="true"
>
  <!-- Background overlay -->
  <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity modal-backdrop"></div>
  
  <!-- Modal container -->
  <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
    <!-- Modal content -->
    <div 
      class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all max-w-md w-full sm:my-8 sm:px-6 sm:py-5"
      data-form-id="recommendations-form"
    >
      <!-- Modal header -->
      <div class="flex items-start sm:items-center">
        <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
          <h3 class="text-xl font-semibold leading-6 text-gray-900" id="name-modal-title">
            One Last Step
          </h3>
        </div>
      </div>
      
      <!-- Modal body -->
      <div class="mt-3">
        <div class="space-y-4">
          <p class="text-gray-600">Please tell us your name so {{ trip.traveler_name }} knows who gave these great recommendations.</p>
          
          <div>
            <label for="modal-recommender-name" class="block text-gray-800 font-semibold mb-2">Your Name <span class="text-red-500">*</span></label>
            <input 
              type="text" 
              id="modal-recommender-name" 
              class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="Enter your name"
              required
            >
          </div>
        </div>
      </div>
      
      <!-- Modal footer -->
      <div class="mt-5 sm:mt-6 sm:flex sm:flex-row-reverse gap-3">
        <button type="button" id="modal-confirm-button" class="inline-flex w-full justify-center rounded-md px-3 py-2 text-sm font-semibold shadow-sm sm:w-auto bg-blue-600 text-white hover:bg-blue-700">
          Submit
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 
  Share Box Component
  
  Required parameters:
  - title: Title of the share box
  - description: Description text
  - share_url: URL to be shared
  - button_text (optional): Custom text for the copy button
-->

<div class="share-box mt-6">
  <h3 class="text-xl font-semibold text-blue-800 mb-3">{{ title }}</h3>
  <p class="text-gray-700 mb-4">{{ description }}</p>
  <div class="relative" id="share-container-{{ id|default('default') }}">
    <input 
      type="text" 
      id="share-link-{{ id|default('default') }}" 
      value="{{ share_url }}" 
      class="form-input pr-10 bg-white text-gray-800 cursor-pointer"
      readonly
    >
    <button 
      class="icon-btn absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-blue-600"
      title="Copy to clipboard"
      id="copy-icon-{{ id|default('default') }}"
      aria-label="Copy link to clipboard"
      type="button"
    >
      <i data-feather="clipboard" class="h-5 w-5"></i>
    </button>
    <div class="copy-feedback absolute inset-0 bg-blue-50 bg-opacity-90 flex items-center justify-center rounded hidden" id="copy-feedback-{{ id|default('default') }}">
      <span class="text-blue-600 font-medium flex items-center">
        <i data-feather="check" class="h-5 w-5 mr-2"></i>
        Copied to clipboard!
      </span>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Feather icons
    if (typeof feather !== 'undefined') {
      feather.replace();
    }
    
    const form = document.getElementById('recommendations-form');
    const addRecommendationButton = document.getElementById('add-recommendation-button');
    const recommendationsContainer = document.getElementById('recommendations-container');
    const newRecTemplate = document.getElementById('new-recommendation-template');
    
    // Counter for new recommendations (used for generating unique IDs)
    // Calculate starting index based on existing recommendations (if any)
    const extractedRecommendationsCount = document.querySelectorAll('.recommendation-item').length;
    let newRecommendationCounter = extractedRecommendationsCount + 1;
    
    // Function to add a new recommendation
    function addNewRecommendation() {
      const container = document.getElementById('recommendations-container');
      const newIndex = container.querySelectorAll('.recommendation-item').length + 1;
      
      // Clone the template
      const template = newRecTemplate.content.cloneNode(true);
      const newItem = template.querySelector('.recommendation-item');
      newItem.id = `recommendation-${newIndex}`;
      
      // Replace all placeholder indices with the actual index
      const html = newItem.outerHTML.replace(/PLACEHOLDER_INDEX/g, newIndex);
      
      // Create the new item from the processed HTML
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      const processedItem = tempDiv.firstElementChild;
      
      // Add the new recommendation to the container
      container.appendChild(processedItem);
      
      // Initialize Feather icons for the new element
      if (typeof feather !== 'undefined') {
        feather.replace();
      }
      
      // Add event listener to the remove button
      const removeButton = processedItem.querySelector('.remove-recommendation');
      if (removeButton) {
        removeButton.addEventListener('click', handleRemoveRecommendation);
      }
      
      // Focus on the first input of the new recommendation
      const firstInput = processedItem.querySelector('input');
      if (firstInput) {
        firstInput.focus();
      }
      
      // Increment the counter for the next recommendation
      newRecommendationCounter++;
    }
    
    // Add event listener to the "Add a Recommendation" button
    if (addRecommendationButton) {
      addRecommendationButton.addEventListener('click', addNewRecommendation);
    }
    
    // If there are no recommendations yet, add one to start
    if (recommendationsContainer && recommendationsContainer.children.length === 0) {
      addNewRecommendation();
    }
    
    // Only initialize form-related functionality if the form exists
    if (form) {
      const submitButton = document.getElementById('submit-button');
      const buttonText = submitButton.querySelector('span');
      const spinner = document.getElementById('spinner');
      const nameInput = document.getElementById('recommender_name');
      const modalNameInput = document.getElementById('modal-recommender-name');
      const modalConfirmButton = document.getElementById('modal-confirm-button');
      const nameModal = document.getElementById('name-modal');
      const modalBackdrop = document.querySelector('.modal-backdrop');
      const clientFlashContainer = document.getElementById('client-flash-container');
      const undoButton = document.getElementById('undo-button');
      
      // Variables to store removed item for undo
      let removedItem = null;
      let removedItemIndex = -1;
      let fadeOutTimer = null;
      let inlineFlashMessage = null;
      
      // If we have a value in the recommender_name input, pre-fill the modal field
      if (nameInput.value) {
        modalNameInput.value = nameInput.value;
      }
      
      // Modal functions
      function showNameModal() {
        nameModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        
        // Focus the name input
        setTimeout(() => {
          modalNameInput.focus();
        }, 100);
      }
      
      function hideNameModal() {
        nameModal.classList.add('hidden');
        document.body.style.overflow = '';
      }
      
      // Close modal when clicking backdrop
      if (modalBackdrop) {
        modalBackdrop.addEventListener('click', hideNameModal);
      }
      
      // Close modal on ESC key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !nameModal.classList.contains('hidden')) {
          hideNameModal();
        }
      });
      
      // Show client flash message
      function showClientFlash(position = null) {
        // Create an inline flash message with the same style as the global one
        if (position) {
          // Remove any existing inline flash
          if (inlineFlashMessage) {
            inlineFlashMessage.remove();
          }
          
          // Clone the flash template
          inlineFlashMessage = document.createElement('div');
          inlineFlashMessage.className = 'bg-yellow-100 text-yellow-800 border border-yellow-300 rounded-lg p-4 mb-4 flex items-center inline-flash-message';
          inlineFlashMessage.innerHTML = `
            <i data-feather="alert-triangle" class="h-5 w-5 mr-3 text-yellow-500"></i>
            <div class="flex-1">Recommendation removed</div>
            <button id="inline-undo-button" class="ml-4 px-3 py-1 bg-white text-gray-800 text-sm rounded hover:bg-gray-200 transition font-medium">
              Undo
            </button>
            <button type="button" class="p-1.5 ml-3 rounded-full hover:bg-white/20">
              <span class="sr-only">Dismiss</span>
              <i data-feather="x" class="h-4 w-4"></i>
            </button>
          `;
          
          // Insert at the specified position
          recommendationsContainer.insertBefore(inlineFlashMessage, position);
          
          // Initialize feather icons
          if (typeof feather !== 'undefined') {
            feather.replace();
          }
          
          // Add event listeners to the inline undo button
          const inlineUndoButton = inlineFlashMessage.querySelector('#inline-undo-button');
          if (inlineUndoButton) {
            inlineUndoButton.addEventListener('click', handleUndo);
          }
          
          // Add event listener to the dismiss button
          const dismissButton = inlineFlashMessage.querySelector('button[type="button"]');
          if (dismissButton) {
            dismissButton.addEventListener('click', function() {
              inlineFlashMessage.remove();
              clearTimeout(fadeOutTimer);
            });
          }
          
          // Set a timer to hide the flash after 5 seconds
          if (fadeOutTimer) clearTimeout(fadeOutTimer);
          fadeOutTimer = setTimeout(() => {
            if (inlineFlashMessage) {
              inlineFlashMessage.remove();
            }
          }, 5000);
        } else {
          // For backwards compatibility, show the global flash container
          clientFlashContainer.classList.remove('hidden');
          
          // Set a timer to hide the flash after 5 seconds
          if (fadeOutTimer) clearTimeout(fadeOutTimer);
          fadeOutTimer = setTimeout(() => {
            clientFlashContainer.classList.add('hidden');
          }, 5000);
        }
      }
      
      // Handle undo functionality
      function handleUndo() {
        if (removedItem && document.getElementById('recommendations-container')) {
          const container = document.getElementById('recommendations-container');
          const items = container.querySelectorAll('.recommendation-item');
          
          // Add the removed item back at its original position
          if (removedItemIndex >= items.length) {
            container.appendChild(removedItem);
          } else if (removedItemIndex === 0) {
            container.insertBefore(removedItem, items[0]);
          } else {
            container.insertBefore(removedItem, items[removedItemIndex]);
          }
          
          // Animate the item appearing
          removedItem.classList.add('opacity-0');
          setTimeout(() => {
            removedItem.classList.remove('opacity-0');
          }, 10);
          
          // Re-attach event listeners to the restored item
          const buttons = removedItem.querySelectorAll('.remove-recommendation');
          buttons.forEach(button => {
            button.addEventListener('click', handleRemoveRecommendation);
          });
          
          // Re-initialize Feather icons
          if (typeof feather !== 'undefined') {
            feather.replace();
          }
          
          // Hide flash
          if (inlineFlashMessage) {
            inlineFlashMessage.remove();
          } else {
            clientFlashContainer.classList.add('hidden');
          }
          clearTimeout(fadeOutTimer);
        }
      }
      
      // Handle removing a recommendation
      function handleRemoveRecommendation(e) {
        e.preventDefault();
        
        // Get the recommendation item
        const index = this.getAttribute('data-index');
        const recommendation = document.getElementById('recommendation-' + index);
        
        if (recommendation) {
          // Store for potential undo
          removedItem = recommendation.cloneNode(true);
          removedItemIndex = Array.from(recommendation.parentNode.children).indexOf(recommendation);
          
          // Get next sibling to use as position marker
          const nextSibling = recommendation.nextElementSibling;
          
          // Remove the recommendation with animation
          recommendation.classList.add('opacity-0', 'transition-opacity', 'duration-300');
          setTimeout(() => {
            recommendation.remove();
            
            // Show inline flash message at the position of the removed item
            showClientFlash(nextSibling);
          }, 300);
        }
      }
      
      // Add event listeners to all remove buttons
      document.querySelectorAll('.remove-recommendation').forEach(button => {
        button.addEventListener('click', handleRemoveRecommendation);
      });
      
      // Undo button functionality (for the global flash)
      if (undoButton) {
        undoButton.addEventListener('click', handleUndo);
      }
      
      // Submit button click handler - show the name modal
      submitButton.addEventListener('click', function() {
        // Check if there are any recommendations left
        const recommendationsCount = document.querySelectorAll('.recommendation-item').length;
        
        if (recommendationsCount === 0) {
          alert('Please add at least one recommendation.');
          return;
        }
        
        // Process all recommendation items before form submission
        const recommendationItems = document.querySelectorAll('.recommendation-item');
        let allValid = true;
        let hasPartialItems = false;
        
        // Remove any existing inline error messages
        document.querySelectorAll('.inline-error-message').forEach(el => el.remove());
        
        recommendationItems.forEach(item => {
          const nameInput = item.querySelector('input[name="recommendations[]"]');
          const typeInput = item.querySelector('input[name="place_types[]"]');
          const descInput = item.querySelector('textarea[name="descriptions[]"]');
          const websiteInput = item.querySelector('input[name="website_urls[]"]');
          
          // Clear any previous error styling
          nameInput.classList.remove('border-red-500');
          
          // Check if all fields are empty in this item
          const isEmpty = (!nameInput.value.trim() && 
                          (!typeInput || !typeInput.value.trim()) && 
                          (!descInput || !descInput.value.trim()) &&
                          (!websiteInput || !websiteInput.value.trim()));
          
          // Check if some fields are filled but not the required name field
          const isPartiallyFilled = !isEmpty && !nameInput.value.trim();
          
          if (isEmpty) {
            // Case 1: If completely empty, mark for removal
            item.classList.add('to-be-removed');
          } else if (isPartiallyFilled) {
            // Case 2: If some fields are filled but not the required name, show error
            hasPartialItems = true;
            
            // Add error styling
            nameInput.classList.add('border-red-500');
            
            // Add error message
            const errorMsg = document.createElement('div');
            errorMsg.className = 'bg-red-50 text-red-700 px-4 py-2 rounded-lg mt-2 inline-error-message';
            errorMsg.textContent = 'Please enter a name for this recommendation';
            item.insertAdjacentElement('afterend', errorMsg);
            
            allValid = false;
          } else {
            // Case 3: Name is valid, check if there are website URLs
            if (!websiteInput) {
              // Create hidden website URL field if it doesn't exist
              const websiteField = document.createElement('input');
              websiteField.type = 'hidden';
              websiteField.name = 'website_urls[]';
              websiteField.value = '';
              nameInput.parentNode.appendChild(websiteField);
            }
          }
        });
        
        // Remove empty items marked for removal
        document.querySelectorAll('.to-be-removed').forEach(item => {
          item.remove();
        });
        
        // If we have partial items with missing required fields, don't proceed
        if (!allValid) {
          return;
        }
        
        // If we already have a name, just submit the form
        if (nameInput.value) {
          form.submit();
        } else {
          // Otherwise show the modal to get the name
          showNameModal();
        }
      });
      
      // Add event listeners to recommendation name inputs to clear errors when typing
      document.addEventListener('input', function(e) {
        if (e.target && e.target.matches('input[name="recommendations[]"]')) {
          // Remove red border
          e.target.classList.remove('border-red-500');
          
          // Find and remove any adjacent error message
          const item = e.target.closest('.recommendation-item');
          if (item && item.nextElementSibling && item.nextElementSibling.classList.contains('inline-error-message')) {
            item.nextElementSibling.remove();
          }
        }
      });
      
      // Modal confirm button
      modalConfirmButton.addEventListener('click', function() {
        const name = modalNameInput.value.trim();
        
        if (!name) {
          modalNameInput.classList.add('border-red-500');
          return;
        }
        
        // Set the name in the hidden input
        nameInput.value = name;
        
        // Hide the modal
        hideNameModal();
        
        // Show loading state
        buttonText.textContent = 'Sending...';
        spinner.classList.remove('hidden');
        submitButton.disabled = true;
        
        // Submit the form
        setTimeout(() => {
          form.submit();
        }, 100);
      });
      
      // Validate input in the modal
      modalNameInput.addEventListener('input', function() {
        if (this.value.trim()) {
          this.classList.remove('border-red-500');
        }
      });
      
      // Handle modal form submission
      nameModal.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && document.activeElement === modalNameInput) {
          e.preventDefault();
          modalConfirmButton.click();
        }
      });
    }
  });

  // IIFE (Immediately Invoked Function Expression) to prevent global scope pollution
  (function() {
    // Wait for page to fully load before attaching event listeners
    window.addEventListener('load', function() {
      console.log('Share box loaded: {{ id|default("default") }}');
      
      // Get references to elements for this specific share box
      const shareId = "{{ id|default('default') }}";
      const input = document.getElementById(`share-link-${shareId}`);
      const button = document.getElementById(`copy-icon-${shareId}`);
      const feedbackElement = document.getElementById(`copy-feedback-${shareId}`);
      
      // Flag to avoid processing select events we trigger programmatically
      let isSelectingProgrammatically = false;
      
      if (input && button && feedbackElement) {
        // Function to handle copying and showing feedback
        const copyToClipboardAndShowFeedback = (source) => {
          console.log(`Copy function called from: ${source}`);
          
          // Mark that we're about to programmatically select text
          isSelectingProgrammatically = true;
          
          // Select the text
          input.select();
          console.log('Text selected');
          
          const text = input.value;
          
          // After a short delay, we can allow select events again
          setTimeout(() => {
            isSelectingProgrammatically = false;
          }, 100);
          
          // Use Clipboard API (modern approach)
          navigator.clipboard.writeText(text).then(() => {
            console.log('Clipboard API success');
            
            // Show feedback
            feedbackElement.classList.remove('hidden');
            console.log('Feedback element shown');
            
            // Hide feedback after 3 seconds
            setTimeout(() => {
              feedbackElement.classList.add('hidden');
              console.log('Feedback element hidden');
            }, 3000);
          }).catch(err => {
            console.log('Clipboard API failed, using fallback', err);
            
            // Fallback to older method for browsers that don't support Clipboard API
            document.execCommand('copy');
            
            // Show feedback
            feedbackElement.classList.remove('hidden');
            console.log('Feedback element shown (fallback)');
            
            // Hide feedback after 3 seconds
            setTimeout(() => {
              feedbackElement.classList.add('hidden');
              console.log('Feedback element hidden (fallback)');
            }, 3000);
          });
        };
        
        // Add click event to the input to select all text and copy to clipboard
        input.addEventListener('click', function(e) {
          console.log('Input clicked');
          // Prevent event propagation to avoid duplicate events
          e.preventDefault();
          e.stopPropagation();
          
          copyToClipboardAndShowFeedback('input click');
        });
        
        // Monitor for select events, but ignore the ones we trigger ourselves
        input.addEventListener('select', function(e) {
          console.log('Input select event triggered, programmatic:', isSelectingProgrammatically);
          
          // If this select event wasn't triggered by our code, ignore it
          if (!isSelectingProgrammatically) {
            // Just log it, don't take any action
            console.log('Ignoring user-initiated select event');
          }
        });
        
        // Add click event to the button to copy the text
        button.addEventListener('click', function(e) {
          console.log('Button clicked');
          e.preventDefault();
          e.stopPropagation();
          
          copyToClipboardAndShowFeedback('button click');
        });
      }
    });
  })();
</script>
{% endblock %} 